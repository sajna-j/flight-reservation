<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Booking App</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>

<div class="container my-5">
    <h1 class="text-center">Flight Booking App</h1>
    
    <!-- Flight Search Section -->
    <div class="card my-3">
        <div class="card-body">
            <h3>Search Flights</h3>
            <form id="search-form">
                <div class="form-row">
                    <div class="col-md-3">
                        <input type="text" id="depart" class="form-control" placeholder="Departure Location" required>
                    </div>
                    <div class="col-md-3">
                        <input type="text" id="arrive" class="form-control" placeholder="Arrival Location" required>
                    </div>
                    <div class="col-md-3">
                        <select id="sort_by" class="form-control">
                            <option value="date">Sort by Date</option>
                            <option value="duration">Sort by Duration</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="route_type" class="form-control">
                            <option value="direct">Direct Flights</option>
                            <option value="indirect">Indirect Flights</option>
                        </select>
                    </div>
                </div>
                </div>
                <button type="submit" class="btn btn-primary mt-3">Search Flights</button>
            </form>
        </div>
    </div>
    
    <!-- Flight Results Section -->
    <div id="flights-list" class="my-3"></div>

    <!-- Seats Section -->
    <div id="seats-list" class="my-3"></div>
</div>

<script>
    // Function to fetch and display seats for a selected flight
    function viewSeats(flightId) {
        fetch(`/flights/${flightId}/seats`)
            .then(response => response.json())
            .then(data => {
                displaySeats(data, flightId);
            })
            .catch(error => console.error('Error fetching seats:', error));
    }

    // Function to display flights in the DOM
    function displayFlights(flights) {
        const flightsList = document.getElementById('flights-list');
        flightsList.innerHTML = '<h3>Available Flights</h3>';
        
        flights.forEach(flight => {
            const flightCard = document.createElement('div');
            flightCard.className = 'card my-2';
            flightCard.innerHTML = `
                <div class="card-body">
                    <h5>Flight ID: ${flight.flight_number}</h5>
                    <p>From: ${flight.departure} - To: ${flight.arrival}</p>
                    <p>Departs: ${flight.date}</p>
                    <p>Duration: ${flight.duration} min</p>
                    <button onclick="viewSeats('${flight.flight_number}')" class="btn btn-secondary">View Seats</button>

                </div>
            `;
            flightsList.appendChild(flightCard);
        });
    }

    // Function to display indirect flights in the DOM
    function displayIndirectFlights(indirectFlights) {
        const flightsList = document.getElementById('flights-list');
        flightsList.innerHTML = '<h3>Available Indirect Flights</h3>';

        // Iterate through each list of flight segments (representing a route)
        indirectFlights.forEach((route, routeIndex) => {
            const routeCard = document.createElement('div');
            routeCard.className = 'card my-3';
            routeCard.innerHTML = `<h5>Indirect Route ${routeIndex + 1}</h5>`;

            // Iterate through each flight segment in the route
            route.forEach((flight, flightIndex) => {
                const flightSegment = document.createElement('div');
                flightSegment.className = 'card my-2';
                flightSegment.innerHTML = `
                    <div class="card-body">
                        <h6>Flight ${flightIndex + 1}</h6>
                        <h5>Flight ID: ${flight.flight_number}</h5>
                        <p>From: ${flight.departure} - To: ${flight.arrival}</p>
                        <p>Departs: ${flight.date}</p>
                        <p>Duration: ${flight.duration} min</p>
                        <button onclick="viewSeats('${flight.flight_number}')" class="btn btn-secondary">View Seats</button>
                    </div>
                `;
                routeCard.appendChild(flightSegment);
            });

            flightsList.appendChild(routeCard);
        });
    }

    // Function to display seats in the DOM with sorting and booking options
    function displaySeats(seats, flightId) {
        const seatsList = document.getElementById('seats-list');
        seatsList.innerHTML = `
            <h3>Seats for Flight ID: ${flightId}</h3>
            <div class="form-group">
                <label for="sort-seats">Sort Seats By:</label>
                <select id="sort-seats" onchange="sortSeats('${flightId}')" class="form-control">
                    <option value="id">Seat ID</option>
                    <option value="cost">Cost</option>
                    <option value="status">Status</option>
                </select>
            </div>
            <div id="seat-items"></div>
        `;
        
        updateSeatItems(seats, flightId);
    }

    // Function to update seat items in the DOM
    function updateSeatItems(seats, flightId) {
        const seatItems = document.getElementById('seat-items');
        seatItems.innerHTML = '';
        
        seats.forEach(seat => {
            const seatCard = document.createElement('div');
            seatCard.className = 'card my-2';
            seatCard.innerHTML = `
                <div class="card-body">
                    <h5>Seat ${seat.seat_number} - ${seat.status}</h5>
                    <p>Cost: $${seat.cost}</p>
                    <button onclick="toggleBooking('${flightId}', '${seat.seat_number}', '${seat.status}')" class="btn btn-${seat.status === 'booked' ? 'danger' : 'primary'}">
                        ${seat.status === 'booked' ? 'Cancel' : 'Book'}
                    </button>
                </div>
            `;
            seatItems.appendChild(seatCard);
        });
    }

    // Function to toggle booking status of a seat
    function toggleBooking(flightId, seatId, status) {
        const url = `/flights/${flightId}/seats/${seatId}/${status === 'booked' ? 'cancel' : 'book'}`;
        
        fetch(url, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                alert(`Seat ${status === 'booked' ? 'cancelled' : 'booked'} successfully.`);
                viewSeats(flightId);
            })
            .catch(error => console.error('Error toggling booking:', error));
    }

    // Function to sort seats and refresh the display
    function sortSeats(flightId) {
        const sortBy = document.getElementById('sort-seats').value;
        
        fetch(`/flights/${flightId}/seats?sort_by=${sortBy}`)
            .then(response => response.json())
            .then(data => {
                updateSeatItems(data, flightId);
            })
            .catch(error => console.error('Error sorting seats:', error));
    }

        // Function to fetch flights based on search criteria
        // Function to fetch flights based on search criteria
    document.getElementById('search-form').addEventListener('submit', function (event) {
        event.preventDefault();

        const depart = document.getElementById('depart').value;
        const arrive = document.getElementById('arrive').value;
        const sort_by = document.getElementById('sort_by').value;
        const route_type = document.getElementById('route_type').value;

        // Clear previous results
        const flightsList = document.getElementById('flights-list');
        const seatsList = document.getElementById('seats-list');
        flightsList.innerHTML = '';
        seatsList.innerHTML = '';

        // Fetch data from the appropriate endpoint
        fetch(`/${route_type}-flights?depart=${depart}&arrive=${arrive}&sort_by=${sort_by}`)
            .then(response => response.json())
            .then(data => {
                if (route_type === 'indirect') {
                    displayIndirectFlights(data);
                } else {
                    displayFlights(data);
                }
            })
            .catch(error => console.error('Error fetching flights:', error));
    });

</script>

</body>
</html>
