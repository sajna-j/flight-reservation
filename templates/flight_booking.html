<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Booking App</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>

<div class="container my-5">
    <h1 class="text-center">Flight Booking App</h1>
    
    <!-- Flight Search Section -->
    <div class="card my-3">
        <div class="card-body">
            <h3>Search Flights</h3>
            <form id="search-form">
                <div class="form-row">
                    <div class="col-md-4">
                        <input type="text" id="depart" class="form-control" placeholder="Departure Location" required>
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="arrive" class="form-control" placeholder="Arrival Location" required>
                    </div>
                    <div class="col-md-4">
                        <select id="sort_by" class="form-control">
                            <option value="date">Sort by Date</option>
                            <option value="duration">Sort by Duration</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary mt-3">Search Flights</button>
            </form>
        </div>
    </div>
    
    <!-- Flight Results Section -->
    <div id="flights-list" class="my-3"></div>

    <!-- Seats Section -->
    <div id="seats-list" class="my-3"></div>
</div>

<script>
    // Function to fetch flights based on search criteria
    document.getElementById('search-form').addEventListener('submit', function(event) {
        event.preventDefault();
        
        const depart = document.getElementById('depart').value;
        const arrive = document.getElementById('arrive').value;
        const sort_by = document.getElementById('sort_by').value;

        fetch(`/direct-flights?depart=${depart}&arrive=${arrive}&sort_by=${sort_by}`)
            .then(response => response.json())
            .then(data => {
                displayFlights(data);
            })
            .catch(error => console.error('Error fetching flights:', error));
    });

    // Function to display flights in the DOM
    function displayFlights(flights) {
        const flightsList = document.getElementById('flights-list');
        flightsList.innerHTML = '<h3>Available Flights</h3>';
        
        flights.forEach(flight => {
            const flightCard = document.createElement('div');
            flightCard.className = 'card my-2';
            flightCard.innerHTML = `
                <div class="card-body">
                    <h5>Flight ID: ${flight.flight_number}</h5>
                    <p>From: ${flight.departure} - To: ${flight.arrival}</p>
                    <button onclick="viewSeats(${flight.flight_number})" class="btn btn-secondary">View Seats</button>
                </div>
            `;
            flightsList.appendChild(flightCard);
        });
    }

    // Function to fetch and display seats for a selected flight
    function viewSeats(flightId) {
        fetch(`/flights/${flightId}/seats`)
            .then(response => response.json())
            .then(data => {
                displaySeats(data, flightId);
            })
            .catch(error => console.error('Error fetching seats:', error));
    }

    // Function to display seats in the DOM with sorting and booking options
    function displaySeats(seats, flightId) {
        const seatsList = document.getElementById('seats-list');
        seatsList.innerHTML = `
            <h3>Seats for Flight ID: ${flightId}</h3>
            <div class="form-group">
                <label for="sort-seats">Sort Seats By:</label>
                <select id="sort-seats" onchange="sortSeats(${flightId})" class="form-control">
                    <option value="cost">Cost</option>
                    <option value="status">Status</option>
                    <option value="id">Seat ID</option>
                </select>
            </div>
            <div id="seat-items"></div>
        `;
        
        updateSeatItems(seats, flightId);
    }

    // Function to update seat items in the DOM
    function updateSeatItems(seats, flightId) {
        const seatItems = document.getElementById('seat-items');
        seatItems.innerHTML = '';
        
        seats.forEach(seat => {
            const seatCard = document.createElement('div');
            seatCard.className = 'card my-2';
            seatCard.innerHTML = `
                <div class="card-body">
                    <h5>Seat ID: ${seat.id} - Class: ${seat.class} - Cost: $${seat.cost}</h5>
                    <p>Status: ${seat.status}</p>
                    <button onclick="toggleBooking(${flightId}, ${seat.id}, '${seat.status}')" class="btn btn-${seat.status === 'booked' ? 'danger' : 'primary'}">
                        ${seat.status === 'booked' ? 'Cancel' : 'Book'}
                    </button>
                </div>
            `;
            seatItems.appendChild(seatCard);
        });
    }

    // Function to toggle booking status of a seat
    function toggleBooking(flightId, seatId, status) {
        const url = `/flights/${flightId}/seats/${seatId}/${status === 'booked' ? 'cancel' : 'book'}`;
        
        fetch(url, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                alert(`Seat ${status === 'booked' ? 'cancelled' : 'booked'} successfully.`);
                viewSeats(flightId);
            })
            .catch(error => console.error('Error toggling booking:', error));
    }

    // Function to sort seats and refresh the display
    function sortSeats(flightId) {
        const sortBy = document.getElementById('sort-seats').value;
        
        fetch(`/flights/${flightId}/seats?sort_by=${sortBy}`)
            .then(response => response.json())
            .then(data => {
                updateSeatItems(data, flightId);
            })
            .catch(error => console.error('Error sorting seats:', error));
    }
</script>

</body>
</html>
